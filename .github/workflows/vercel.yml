name: Vercel Deployment Notifications

on:
  deployment_status:

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'failure'
    
    steps:
      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Get Deployment Logs
        id: logs
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Get the latest deployment logs
          LOGS=$(vercel logs ${{ github.event.repository.name }} --token $VERCEL_TOKEN 2>&1 | tail -n 100)
          
          # Truncate and escape for JSON
          LOGS=$(echo "$LOGS" | head -c 3900 | jq -Rs .)
          echo "deployment_logs=$LOGS" >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          LOGS: ${{ steps.logs.outputs.deployment_logs }}
        run: |
          LOGS_FORMATTED=$(echo "$LOGS" | sed 's/^"//;s/"$//' | sed 's/\\n/\n/g')
          
          curl -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"embeds\": [{
              \"title\": \"ðŸš¨ Vercel Deployment Failed\",
              \"color\": 15158332,
              \"fields\": [
                {
                  \"name\": \"Repository\",
                  \"value\": \"${{ github.repository }}\"
                },
                {
                  \"name\": \"Branch\",
                  \"value\": \"${{ github.ref_name }}\"
                }
              ]
            },
            {
              \"title\": \"ðŸ“‹ Build Logs\",
              \"description\": \"\`\`\`\n${LOGS_FORMATTED}\n\`\`\`\",
              \"color\": 15158332
            }]
          }" \
          $DISCORD_WEBHOOK